<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Плащане</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans p-4 md:p-8">

  <header class="bg-white shadow-md rounded-xl mb-8 p-4 md:p-6">
    <div class="container mx-auto flex justify-between items-center">
      <a href="#" class="text-3xl font-bold text-gray-900">Husora</a>
      <nav class="flex space-x-4">
        <a href="#" class="text-gray-600 hover:text-blue-600">Начало</a>
        <a href="#" class="text-gray-600 hover:text-blue-600">Кошница</a>
        <a href="delivery.html" class="text-gray-600 hover:text-blue-600">Доставка</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto">
    <div class="bg-white rounded-xl shadow-lg p-6 md:p-10">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 mb-6">Начин на плащане</h1>

      <div class="bg-white rounded-lg p-6 shadow-sm mb-8">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M22 6.5C22 7.32843 21.3284 8 20.5 8H3.5C2.67157 8 2 7.32843 2 6.5V3.5C2 2.67157 2.67157 2 3.5 2H20.5C21.3284 2 22 2.67157 22 3.5V6.5Z"></path>
              <path d="M22 17.5C22 18.3284 21.3284 19 20.5 19H3.5C2.67157 19 2 18.3284 2 17.5V10H22V17.5Z"></path>
              <path fill-rule="evenodd" clip-rule="evenodd" d="M2 13H22V15H2V13Z"></path>
            </svg>
            <div class="ml-4">
              <p class="font-medium text-gray-900">Плащане на място с наложен платеж</p>
              <p class="text-sm text-gray-500">Плащате на куриера при получаване на пратката.</p>
            </div>
          </div>
          <input type="radio" name="payment_method" value="Плащане на място" checked
                 class="form-radio text-blue-600 h-5 w-5 rounded-full">
        </div>
      </div>
      
      <div id="status-message" class="mt-4 p-4 text-center rounded-lg font-medium hidden"></div>

      <button id="confirm-payment-button"
              class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
        Потвърди и плати
      </button>

    </div>
  </main>

  <footer class="container mx-auto text-center text-gray-600 mt-8 p-4">
    <p>&copy; 2024 Husora. Всички права запазени.</p>
  </footer>

<script>
  // This is the URL of your deployed Google Apps Script Web App.
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQDoC7t-fHWzXO3PpEgrg6fs7SaAOIuTuxjPNZ7pQkW5QHeyhz7TLaWKLbtJuO_qOb/exec";

  // Handle payment confirmation
  async function handlePaymentConfirm() {
    const deliveryDetails = JSON.parse(localStorage.getItem("deliveryDetails")) || {};
    const cart = JSON.parse(localStorage.getItem("cart")) || [];
    
    // Check if cart or delivery details are missing
    if (Object.keys(deliveryDetails).length === 0 || cart.length === 0) {
      const statusMessage = document.getElementById("status-message");
      statusMessage.textContent = "⚠️ Грешка: Липсват данни за поръчката. Моля, върнете се на предишната стъпка.";
      statusMessage.className = "mt-4 p-4 text-center rounded-lg font-medium text-red-600 bg-red-100 block";
      return;
    }

    const orderData = {
      ...deliveryDetails,
      payment_method: "Плащане на място", // Assuming this is the only option
      cart: cart,
    };

    const statusMessage = document.getElementById("status-message");
    const confirmButton = document.getElementById("confirm-payment-button");

    statusMessage.textContent = "Изпращане на поръчката...";
    statusMessage.className = "mt-4 p-4 text-center rounded-lg font-medium text-blue-600 bg-blue-100 block";
    confirmButton.disabled = true;

    try {
      const response = await fetch(SCRIPT_URL, {
        method: "POST",
        body: JSON.stringify(orderData),
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) {
        throw new Error(`HTTP Error: ${response.status}`);
      }

      const result = await response.json();
      if (result.result === "success") {
        statusMessage.textContent = "Благодарим Ви! Вашата поръчка е записана.";
        statusMessage.className = "mt-4 p-4 text-center rounded-lg font-medium text-green-600 bg-green-100 block";
        localStorage.removeItem("cart");
        localStorage.removeItem("deliveryDetails");
        // Optional: Redirect after a delay
        setTimeout(() => {
          window.location.href = "index.html";
        }, 3000);
      } else {
        throw new Error("API Error: " + result.error);
      }
    } catch (error) {
      statusMessage.textContent = "⚠️ Грешка при запис: " + error.message;
      statusMessage.className = "mt-4 p-4 text-center rounded-lg font-medium text-red-600 bg-red-100 block";
      console.error("Error:", error);
    } finally {
      confirmButton.disabled = false;
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const confirmButton = document.getElementById("confirm-payment-button");
    if (confirmButton) {
      confirmButton.addEventListener("click", handlePaymentConfirm);
    }
  });
</script>

</body>
</html>
